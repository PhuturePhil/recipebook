name: Deploy to Hetzner

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Hetzner
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USER }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          script: |
            cd /opt/recipebook
            git pull origin main
            
            # Create docker-compose.prod.yml
            cat > docker-compose.prod.yml << 'EOF'
            version: '3.8'

            services:
              postgres:
                image: postgres:16-alpine
                container_name: recipebook-db
                hostname: postgres
                networks:
                  - recipebook_default
                environment:
                  POSTGRES_DB: recipebook
                  POSTGRES_USER: postgres
                  POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
                volumes:
                  - postgres_data:/var/lib/postgresql/data
                restart: unless-stopped

              backend:
                build: 
                  context: ./backend
                  dockerfile: Dockerfile
                container_name: recipebook-backend
                hostname: backend
                networks:
                  - recipebook_default
                ports:
                  - "8080:8080"
                environment:
                  SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/recipebook
                  SPRING_DATASOURCE_USERNAME: postgres
                  SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}
                  JWT_SECRET: ${JWT_SECRET}
                  ADMIN_PASSWORD: ${ADMIN_PASSWORD}
                  APP_URL: https://pastoors.cloud
                  ALLOWED_ORIGIN: https://pastoors.cloud
                  OPENAI_API_KEY: ${OPENAI_API_KEY}
                depends_on:
                  - postgres
                restart: unless-stopped

              frontend:
                build: 
                  context: ./frontend
                  dockerfile: Dockerfile
                container_name: recipebook-frontend
                hostname: frontend
                networks:
                  - recipebook_default
                ports:
                  - "80:80"
                  - "443:443"
                volumes:
                  - /opt/ssl/pastoors.cloud:/etc/ssl/certs:ro
                depends_on:
                  - backend
                restart: unless-stopped

            networks:
              recipebook_default:
                external: true

            volumes:
              postgres_data:
            EOF
            
            # Copy nginx SSL config
            cp frontend/nginx-ssl.conf frontend/nginx.conf
            
            # Create network if not exists
            docker network create recipebook_default 2>/dev/null || true
            
            # Remove old containers
            docker rm -f recipebook-db recipebook-backend recipebook-frontend 2>/dev/null || true
            
            # Build and start (using Docker Compose V2)
            # Use --no-cache to ensure fresh builds
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }} JWT_SECRET=${{ secrets.JWT_SECRET }} ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }} OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }} docker compose -f docker-compose.prod.yml build --no-cache
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }} JWT_SECRET=${{ secrets.JWT_SECRET }} ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }} OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }} docker compose -f docker-compose.prod.yml up -d
