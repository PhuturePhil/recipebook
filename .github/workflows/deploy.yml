name: Deploy to Hetzner

on:
  push:
    branches: [main]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set lowercase owner
        id: owner
        run: echo "value=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ghcr.io/${{ steps.owner.outputs.value }}/recipebook-backend:latest

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ghcr.io/${{ steps.owner.outputs.value }}/recipebook-frontend:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Deploy to Hetzner
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USER }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          envs: GHCR_TOKEN,REPO_OWNER
          script: |
            REPO_OWNER=$(echo "$REPO_OWNER" | tr '[:upper:]' '[:lower:]')

            # Login to GitHub Container Registry
            echo "$GHCR_TOKEN" | docker login ghcr.io -u "$REPO_OWNER" --password-stdin

            # Pull latest images
            docker pull ghcr.io/$REPO_OWNER/recipebook-backend:latest
            docker pull ghcr.io/$REPO_OWNER/recipebook-frontend:latest

            # Create docker-compose.prod.yml
            cat > /opt/recipebook/docker-compose.prod.yml << 'EOF'
            version: '3.8'

            services:
              postgres:
                image: postgres:16-alpine
                container_name: recipebook-db
                hostname: postgres
                networks:
                  - recipebook_default
                environment:
                  POSTGRES_DB: recipebook
                  POSTGRES_USER: postgres
                  POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
                volumes:
                  - postgres_data:/var/lib/postgresql/data
                restart: unless-stopped

              backend:
                image: ghcr.io/phuturephil/recipebook-backend:latest
                container_name: recipebook-backend
                hostname: backend
                networks:
                  - recipebook_default
                ports:
                  - "8080:8080"
                environment:
                  SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/recipebook
                  SPRING_DATASOURCE_USERNAME: postgres
                  SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}
                  JWT_SECRET: ${JWT_SECRET}
                  ADMIN_PASSWORD: ${ADMIN_PASSWORD}
                  APP_URL: https://pastoors.cloud
                  ALLOWED_ORIGIN: https://pastoors.cloud
                  OPENAI_API_KEY: ${OPENAI_API_KEY}
                depends_on:
                  - postgres
                restart: unless-stopped

              frontend:
                image: ghcr.io/phuturephil/recipebook-frontend:latest
                container_name: recipebook-frontend
                hostname: frontend
                networks:
                  - recipebook_default
                ports:
                  - "80:80"
                  - "443:443"
                volumes:
                  - /opt/ssl/pastoors.cloud:/etc/ssl/certs:ro
                depends_on:
                  - backend
                restart: unless-stopped

            networks:
              recipebook_default:
                external: true

            volumes:
              postgres_data:
            EOF

            # Create network if not exists
            docker network create recipebook_default 2>/dev/null || true

            # Remove old containers
            docker rm -f recipebook-db recipebook-backend recipebook-frontend 2>/dev/null || true

            # Start containers - secrets are loaded from .env file
            docker compose --env-file /opt/recipebook/.env -f /opt/recipebook/docker-compose.prod.yml up -d
        env:
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          REPO_OWNER: ${{ github.repository_owner }}
